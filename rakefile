require 'fileutils'
require 'rake/clean'

require_relative 'rake/libs'
require_relative 'rake/base'
require_relative 'rake/tools'
require_relative 'rake/ndbl'
require_relative 'rake/_cmake'

CLEAN.include [OBJ_DIR, DEP_DIR] # intermediate files
CLOBBER.include [BUILD_DIR] # final files

task :default => :help

desc "says hello"
task :help do
    print("Welcome to Nodable's rakefile.\nFor more info, run: rake --tasks\n")
end

task :install => [
    'update_system',
    'nfd:install', # TODO: replace by GTK for DESKTOP, and JS for WEB
];
task :build => ['libs:build', 'tools:build', 'ndbl:build'] do puts "Build DONE" end
task :test  => ['tools:test', 'ndbl:test']
task :run   => ['ndbl:app:run']

task :update_system do
    if not BUILD_OS_LINUX
        raise "Your system (#{BUILD_OS}) is not supported by this script"
    end

    packages = [
        "build-essential",
        "libegl1-mesa-dev",
        "libdbus-1-dev",
        "libgtk-3-dev", # for NDF (native file dialog), can theoretically be removed see NFD_sdl.h
        "libgtest-dev",
        "libfreetype-dev",
        "libsdl2-dev",
        # "libstdc++-11-dev", comes with clang in principle
    ].join(" ")

    sh "sudo apt-get update && sudo apt-get install #{packages}"

    if PLATFORM_WEB
        # Download and install the latest SDK tools.
        sh "libs/emsdk/emsdk install latest"

        # Make the "latest" SDK "active" for the current user. (writes .emscripten file)
        sh "libs/emsdk/emsdk activate latest"
    end
end

namespace :nfd do
    nfd = CMakeTarget.new(name: "nfd", path: "libs/nativefiledialog-extended" )
    tasks_for_cmake_target( nfd )
end
